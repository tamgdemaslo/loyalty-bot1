# Миграция с SQLite на PostgreSQL

Это руководство описывает процесс миграции бота и веб-приложения с SQLite на PostgreSQL.

## Подготовка

### 1. Создание базы данных PostgreSQL

Создайте базу данных на сервисе Render или другой PostgreSQL хостинг-платформе.

После создания получите следующие данные для подключения:
- Имя хоста (host)
- Порт (обычно 5432)
- Имя базы данных
- Имя пользователя
- Пароль

### 2. Установка зависимостей

#### Для бота (Python)
```bash
pip install psycopg2-binary python-dotenv
```

#### Для веб-приложения (Node.js)
```bash
cd miniapp
npm install pg dotenv
```

### 3. Создание файлов конфигурации

Создайте файл `.env.postgres` в корне проекта для бота:

```
POSTGRES_HOST=your_postgres_host
POSTGRES_PORT=5432
POSTGRES_USER=your_postgres_user
POSTGRES_PASSWORD=your_postgres_password
POSTGRES_DB=your_postgres_database
```

Создайте аналогичный файл `.env.postgres` в директории `miniapp` для веб-приложения.

## Миграция

### 1. Создание таблиц и перенос данных

1. Запустите скрипт создания схемы PostgreSQL:
   ```bash
   python create_postgres_schema.py
   ```

2. Запустите скрипт переноса данных из SQLite в PostgreSQL:
   ```bash
   python migrate_data.py
   ```

### 2. Обновление кода для использования PostgreSQL

#### Обновление бота
1. В директории бота выполните скрипт для обновления импортов:
   ```bash
   cd bot
   python update_imports.py
   ```

#### Обновление веб-приложения
1. В директории веб-приложения выполните скрипт для обновления импорта в server.js:
   ```bash
   cd miniapp
   node update_server_postgres.js
   ```

## Проверка миграции

### 1. Запуск бота с новой базой данных
```bash
cd bot
python bot.py
```

### 2. Запуск веб-приложения с новой базой данных
```bash
cd miniapp
node server.js
```

## Возможные проблемы и решения

### 1. Ошибки подключения к PostgreSQL
- Проверьте параметры подключения в файлах `.env.postgres`
- Проверьте сетевые настройки и доступность базы данных
- Убедитесь, что IP-адрес вашего сервера добавлен в список разрешенных в настройках базы данных

### 2. Ошибки в работе с транзакциями
- Проверьте корректность транзакций в функциях бота и веб-приложения
- Убедитесь, что все транзакции корректно закрываются (коммит или откат)

### 3. Проблемы с типами данных
- SQLite и PostgreSQL могут по-разному обрабатывать некоторые типы данных
- Особенно внимательно проверьте работу с датами, булевыми значениями и целыми числами

## Откат миграции

Если возникли непредвиденные проблемы, вы всегда можете вернуться к SQLite:

1. Для бота - отмените изменения импортов или используйте оригинальный модуль db.py
2. Для веб-приложения - измените импорт обратно на api_integration.js в файле server.js

## Дополнительные рекомендации

1. Регулярно делайте резервные копии PostgreSQL базы данных
2. Настройте мониторинг для отслеживания производительности базы данных
3. Рассмотрите возможность создания реплик базы данных для обеспечения высокой доступности
