<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoService - –°–∏—Å—Ç–µ–º–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        
        .gradient-gold { background: linear-gradient(135deg, #FFD700, #FFA500); }
        .gradient-silver { background: linear-gradient(135deg, #C0C0C0, #808080); }
        .gradient-bronze { background: linear-gradient(135deg, #CD7F32, #B8860B); }
        .gradient-platinum { background: linear-gradient(135deg, #E5E4E2, #C0C0C0); }
        .gradient-diamond { background: linear-gradient(135deg, #B9F2FF, #1E90FF); }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        
        .btn-hover {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .btn-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div id="app" class="min-h-screen">
        <!-- Loading Screen -->
        <div id="loading" class="fixed inset-0 bg-gradient-to-br from-indigo-600 via-purple-600 to-pink-600 flex items-center justify-center z-50">
            <div class="text-center text-white">
                <div class="w-20 h-20 mx-auto mb-4 rounded-2xl bg-white/20 glass-effect flex items-center justify-center text-3xl animate-pulse">
                    üöó
                </div>
                <h1 class="text-2xl font-bold mb-2">AutoService</h1>
                <p class="text-indigo-200">–ó–∞–≥—Ä—É–∂–∞–µ–º –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ...</p>
                <div class="mt-4 w-32 h-1 bg-white/20 rounded-full mx-auto overflow-hidden">
                    <div class="h-full bg-white rounded-full animate-pulse"></div>
                </div>
            </div>
        </div>

        <!-- Mobile Header -->
        <header id="mobile-header" class="lg:hidden bg-white border-b border-gray-200 sticky top-0 z-40 hidden">
            <div class="flex items-center justify-between p-4">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-indigo-600 to-purple-600 rounded-xl flex items-center justify-center text-white font-bold text-lg">
                        üöó
                    </div>
                    <div>
                        <h1 class="text-lg font-bold text-gray-900">AutoService</h1>
                        <p class="text-xs text-gray-500">–ü—Ä–µ–º–∏—É–º-—Å–µ—Ä–≤–∏—Å</p>
                    </div>
                </div>
                
                <button id="mobile-menu-btn" class="w-10 h-10 rounded-xl bg-gray-100 flex items-center justify-center">
                    <span class="text-xl">‚ò∞</span>
                </button>
            </div>
            
            <!-- Mobile Menu -->
            <div id="mobile-menu" class="hidden absolute top-full left-0 right-0 bg-white border-b border-gray-200 p-4">
                <div class="grid grid-cols-5 gap-2" id="mobile-nav-items">
                    <!-- Navigation items will be inserted here -->
                </div>
            </div>
        </header>

        <div class="flex h-screen lg:h-auto">
            <!-- Desktop Sidebar -->
            <aside id="desktop-sidebar" class="hidden lg:flex lg:flex-col w-64 bg-white border-r border-gray-200 p-6">
                <div class="flex items-center space-x-3 mb-8">
                    <div class="w-12 h-12 bg-gradient-to-br from-indigo-600 to-purple-600 rounded-xl flex items-center justify-center text-white font-bold text-xl">
                        üöó
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-gray-900">AutoService</h1>
                        <p class="text-sm text-gray-500">–ü—Ä–µ–º–∏—É–º-—Å–µ—Ä–≤–∏—Å</p>
                    </div>
                </div>
                
                <nav class="space-y-2 flex-1" id="desktop-nav">
                    <!-- Navigation items will be inserted here -->
                </nav>
                
                <div class="border-t border-gray-200 pt-4">
                    <div class="flex items-center space-x-3">
                        <div id="user-avatar" class="w-10 h-10 bg-gradient-to-br from-indigo-600 to-purple-600 rounded-xl flex items-center justify-center text-white text-sm font-bold">
                            U
                        </div>
                        <div class="flex-1">
                            <p id="sidebar-user-name" class="text-sm font-medium text-gray-900">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</p>
                            <p id="sidebar-user-balance" class="text-xs text-gray-500">0 ‚ÇΩ</p>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Main Content -->
            <main class="flex-1 p-4 lg:p-8 overflow-auto hide-scrollbar">
                <div class="max-w-7xl mx-auto">
                    <!-- Dashboard Page -->
                    <div id="page-dashboard" class="page-content space-y-6">
                        <!-- Welcome Section -->
                        <div class="relative overflow-hidden rounded-3xl bg-gradient-to-br from-indigo-600 via-purple-600 to-pink-600 p-6 md:p-8">
                            <div class="absolute inset-0">
                                <div class="absolute top-4 right-4 w-32 h-32 bg-white/10 rounded-full blur-2xl"></div>
                                <div class="absolute bottom-4 left-4 w-24 h-24 bg-white/5 rounded-full blur-xl"></div>
                            </div>
                            <div class="relative z-10">
                                <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                                    <div>
                                        <h1 id="welcome-text" class="text-2xl md:text-3xl font-bold text-white mb-1">
                                            –ü—Ä–∏–≤–µ—Ç, –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å! üëã
                                        </h1>
                                        <p class="text-indigo-100 opacity-90">
                                            –í–∞—à –ø—Ä–µ–º–∏—É–º –∞–≤—Ç–æ—Å–µ—Ä–≤–∏—Å –≤—Å–µ–≥–¥–∞ –≥–æ—Ç–æ–≤ –ø–æ–º–æ—á—å
                                        </p>
                                    </div>
                                    <div class="glass-effect rounded-2xl p-4 text-center">
                                        <div id="bonus-display" class="text-2xl md:text-3xl font-bold text-white">
                                            0 ‚ÇΩ
                                        </div>
                                        <div class="text-indigo-100 text-sm">–ë–æ–Ω—É—Å—ã</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Quick Stats -->
                        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4" id="quick-stats">
                            <!-- Stats cards will be inserted here -->
                        </div>

                        <!-- Analytics & Services -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Chart -->
                            <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 btn-hover">
                                <h3 class="text-lg font-bold text-gray-900 mb-4">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ –º–µ—Å—è—Ü—ã</h3>
                                <div class="h-48">
                                    <canvas id="analyticsChart" width="400" height="200"></canvas>
                                </div>
                            </div>

                            <!-- Recent Transactions -->
                            <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 btn-hover">
                                <h3 class="text-lg font-bold text-gray-900 mb-4">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏</h3>
                                <div id="recent-transactions" class="space-y-3">
                                    <!-- Transactions will be inserted here -->
                                </div>
                            </div>
                        </div>

                        <!-- Quick Actions -->
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <button class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 btn-hover text-center group" onclick="showPage('booking')">
                                <div class="w-12 h-12 mx-auto mb-3 rounded-xl bg-blue-100 flex items-center justify-center text-2xl group-hover:scale-110 transition-transform">
                                    üìÖ
                                </div>
                                <p class="text-gray-900 font-medium">–ó–∞–ø–∏—Å–∞—Ç—å—Å—è</p>
                            </button>
                            
                            <button class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 btn-hover text-center group" onclick="showPage('visits')">
                                <div class="w-12 h-12 mx-auto mb-3 rounded-xl bg-green-100 flex items-center justify-center text-2xl group-hover:scale-110 transition-transform">
                                    üìã
                                </div>
                                <p class="text-gray-900 font-medium">–ò—Å—Ç–æ—Ä–∏—è</p>
                            </button>
                            
                            <button class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 btn-hover text-center group" onclick="showPage('maintenance')">
                                <div class="w-12 h-12 mx-auto mb-3 rounded-xl bg-yellow-100 flex items-center justify-center text-2xl group-hover:scale-110 transition-transform">
                                    üîß
                                </div>
                                <p class="text-gray-900 font-medium">–¢–û</p>
                            </button>
                            
                            <button class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 btn-hover text-center group" onclick="redeemBonuses()">
                                <div class="w-12 h-12 mx-auto mb-3 rounded-xl bg-purple-100 flex items-center justify-center text-2xl group-hover:scale-110 transition-transform">
                                    üíé
                                </div>
                                <p class="text-gray-900 font-medium">–°–ø–∏—Å–∞—Ç—å</p>
                            </button>
                        </div>
                    </div>

                    <!-- Visits Page -->
                    <div id="page-visits" class="page-content space-y-6 hidden">
                        <div class="flex items-center justify-between">
                            <h2 class="text-2xl font-bold text-gray-900">–ò—Å—Ç–æ—Ä–∏—è –ø–æ—Å–µ—â–µ–Ω–∏–π</h2>
                            <button onclick="showPage('dashboard')" class="text-indigo-600 hover:text-indigo-700 font-medium">
                                ‚Üê –ù–∞–∑–∞–¥
                            </button>
                        </div>
                        <div id="visits-list" class="space-y-4">
                            <!-- Visits will be inserted here -->
                        </div>
                    </div>

                    <!-- Transactions Page -->
                    <div id="page-transactions" class="page-content space-y-6 hidden">
                        <div class="flex items-center justify-between">
                            <h2 class="text-2xl font-bold text-gray-900">–ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π</h2>
                            <button onclick="showPage('dashboard')" class="text-indigo-600 hover:text-indigo-700 font-medium">
                                ‚Üê –ù–∞–∑–∞–¥
                            </button>
                        </div>
                        <div id="transactions-list" class="space-y-4">
                            <!-- Transactions will be inserted here -->
                        </div>
                    </div>

                    <!-- Maintenance Page -->
                    <div id="page-maintenance" class="page-content space-y-6 hidden">
                        <div class="flex items-center justify-between">
                            <h2 class="text-2xl font-bold text-gray-900">–¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ</h2>
                            <button onclick="showPage('dashboard')" class="text-indigo-600 hover:text-indigo-700 font-medium">
                                ‚Üê –ù–∞–∑–∞–¥
                            </button>
                        </div>
                        <div id="maintenance-list" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- Maintenance items will be inserted here -->
                        </div>
                    </div>

                    <!-- Booking Page -->
                    <div id="page-booking" class="page-content space-y-6 hidden">
                        <div class="flex items-center justify-between">
                            <h2 class="text-2xl font-bold text-gray-900">–û–Ω–ª–∞–π–Ω –∑–∞–ø–∏—Å—å</h2>
                            <button onclick="showPage('dashboard')" class="text-indigo-600 hover:text-indigo-700 font-medium">
                                ‚Üê –ù–∞–∑–∞–¥
                            </button>
                        </div>
                        
                        <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
                            <h3 class="text-lg font-bold text-gray-900 mb-4">–í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É</h3>
                            <div id="services-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                <!-- Services will be inserted here -->
                            </div>
                        </div>
                    </div>

                    <!-- Profile Page -->
                    <div id="page-profile" class="page-content space-y-6 hidden">
                        <div class="flex items-center justify-between">
                            <h2 class="text-2xl font-bold text-gray-900">–ü—Ä–æ—Ñ–∏–ª—å</h2>
                            <button onclick="showPage('dashboard')" class="text-indigo-600 hover:text-indigo-700 font-medium">
                                ‚Üê –ù–∞–∑–∞–¥
                            </button>
                        </div>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div class="lg:col-span-2 space-y-6">
                                <!-- Profile Info -->
                                <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
                                    <h3 class="text-lg font-bold text-gray-900 mb-4">–õ–∏—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
                                    <div class="space-y-4">
                                        <div>
                                            <label class="block text-gray-700 text-sm font-medium mb-2">–ü–æ–ª–Ω–æ–µ –∏–º—è</label>
                                            <input id="profile-name" type="text" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:border-indigo-500 focus:outline-none transition-colors">
                                        </div>
                                        <div>
                                            <label class="block text-gray-700 text-sm font-medium mb-2">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                                            <input id="profile-phone" type="text" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:border-indigo-500 focus:outline-none transition-colors">
                                        </div>
                                        <div>
                                            <label class="block text-gray-700 text-sm font-medium mb-2">Telegram ID</label>
                                            <input id="profile-telegram-id" type="text" readonly class="w-full p-3 bg-gray-100 border border-gray-200 rounded-xl text-gray-600">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="space-y-6">
                                <!-- Loyalty Card -->
                                <div id="loyalty-card" class="bg-gradient-to-br from-indigo-600 via-purple-600 to-pink-600 rounded-2xl p-6 text-white">
                                    <div class="text-center">
                                        <div class="w-16 h-16 mx-auto mb-4 rounded-full glass-effect flex items-center justify-center text-2xl">
                                            üëë
                                        </div>
                                        <h4 id="loyalty-level-name" class="text-xl font-bold mb-2">
                                            –ë—Ä–æ–Ω–∑–∞
                                        </h4>
                                        <p id="loyalty-level-benefits" class="text-indigo-100 mb-4 text-sm">
                                            5% –∫—ç—à–±—ç–∫ ‚Ä¢ –¥–æ 30% —Å–∫–∏–¥–∫–∞
                                        </p>
                                        <div class="w-full bg-white/20 rounded-full h-2 mb-2">
                                            <div id="loyalty-progress" class="bg-white h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
                                        </div>
                                        <p id="loyalty-progress-text" class="text-xs text-indigo-100">
                                            –ó–∞–≥—Ä—É–∑–∫–∞...
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <!-- Mobile Bottom Navigation -->
        <nav id="mobile-bottom-nav" class="lg:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 p-2 hidden">
            <div class="flex justify-around" id="bottom-nav-items">
                <!-- Navigation items will be inserted here -->
            </div>
        </nav>

        <!-- Redeem Modal -->
        <div id="redeem-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl p-6 w-full max-w-md">
                <h3 class="text-xl font-bold text-gray-900 mb-4">–°–ø–∏—Å–∞–Ω–∏–µ –±–æ–Ω—É—Å–æ–≤</h3>
                
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-medium mb-2">–°—É–º–º–∞ –∫ —Å–ø–∏—Å–∞–Ω–∏—é</label>
                    <input id="redeem-amount" type="number" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É" class="w-full p-3 border border-gray-200 rounded-xl focus:border-indigo-500 focus:outline-none">
                    <p class="text-xs text-gray-500 mt-1">–î–æ—Å—Ç—É–ø–Ω–æ: <span id="available-balance">0</span> ‚ÇΩ</p>
                </div>
                
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-medium mb-2">–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                    <input id="redeem-description" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –æ–ø–ª–∞—Ç–∞ —É—Å–ª—É–≥–∏" class="w-full p-3 border border-gray-200 rounded-xl focus:border-indigo-500 focus:outline-none">
                </div>
                
                <div class="flex space-x-3">
                    <button onclick="closeRedeemModal()" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 py-3 rounded-xl font-medium transition-colors">
                        –û—Ç–º–µ–Ω–∞
                    </button>
                    <button onclick="confirmRedeem()" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded-xl font-medium transition-colors">
                        –°–ø–∏—Å–∞—Ç—å
                    </button>
                </div>
            </div>
        </div>

        <!-- Toast Notifications -->
        <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2">
            <!-- Toast messages will be inserted here -->
        </div>
    </div>

    <script>
        // Global variables
        let currentPage = 'dashboard';
        let userData = null;

        // Initialize Telegram WebApp
        if (window.Telegram && window.Telegram.WebApp) {
            window.Telegram.WebApp.ready();
            window.Telegram.WebApp.expand();
        }
        
        // Setup bypass for localtunnel password page
        if (window.location.hostname.includes('loca.lt')) {
            const originalFetch = window.fetch;
            window.fetch = function(...args) {
                if (args[1]) {
                    args[1].headers = {
                        ...args[1].headers,
                        'bypass-tunnel-reminder': 'true',
                        'User-Agent': 'TelegramWebApp/1.0'
                    };
                } else {
                    args[1] = {
                        headers: {
                            'bypass-tunnel-reminder': 'true',
                            'User-Agent': 'TelegramWebApp/1.0'
                        }
                    };
                }
                return originalFetch.apply(this, args);
            };
        }

        // Navigation data
        const pages = {
            dashboard: { name: '–ì–ª–∞–≤–Ω–∞—è', icon: 'üè†' },
            visits: { name: '–ü–æ—Å–µ—â–µ–Ω–∏—è', icon: 'üìã' },
            transactions: { name: '–û–ø–µ—Ä–∞—Ü–∏–∏', icon: 'üí∞' },
            maintenance: { name: '–¢–û', icon: 'üîß' },
            booking: { name: '–ó–∞–ø–∏—Å—å', icon: 'üìÖ' },
            profile: { name: '–ü—Ä–æ—Ñ–∏–ª—å', icon: 'üë§' }
        };

        // Loyalty levels configuration
        const loyaltyLevels = {
            1: { name: '–ë—Ä–æ–Ω–∑–∞', bonus: 5, discount: 30, min: 0 },
            2: { name: '–°–µ—Ä–µ–±—Ä–æ', bonus: 7, discount: 35, min: 15000 },
            3: { name: '–ó–æ–ª–æ—Ç–æ', bonus: 10, discount: 40, min: 40000 },
            4: { name: '–ü–ª–∞—Ç–∏–Ω–∞', bonus: 15, discount: 50, min: 100000 },
            5: { name: '–ê–ª–º–∞–∑', bonus: 20, discount: 60, min: 200000 }
        };

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            setupNavigation();
            loadUserData();
        });

        // Setup navigation
        function setupNavigation() {
            const desktopNav = document.getElementById('desktop-nav');
            const mobileNavItems = document.getElementById('mobile-nav-items');
            const bottomNavItems = document.getElementById('bottom-nav-items');

            Object.entries(pages).forEach(([key, page]) => {
                // Desktop navigation
                const desktopBtn = document.createElement('button');
                desktopBtn.className = `w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-colors font-medium text-gray-600 hover:bg-gray-100`;
                desktopBtn.innerHTML = `<span class="text-xl">${page.icon}</span><span>${page.name}</span>`;
                desktopBtn.onclick = () => showPage(key);
                desktopNav.appendChild(desktopBtn);

                // Mobile navigation
                const mobileBtn = document.createElement('button');
                mobileBtn.className = `flex flex-col items-center space-y-1 p-3 rounded-xl transition-colors text-gray-600 hover:bg-gray-100`;
                mobileBtn.innerHTML = `<span class="text-xl">${page.icon}</span><span class="text-xs font-medium">${page.name}</span>`;
                mobileBtn.onclick = () => {
                    showPage(key);
                    toggleMobileMenu(false);
                };
                mobileNavItems.appendChild(mobileBtn);

                // Bottom navigation
                const bottomBtn = document.createElement('button');
                bottomBtn.className = `flex flex-col items-center space-y-1 p-2 rounded-xl transition-colors text-gray-500`;
                bottomBtn.innerHTML = `<span class="text-xl">${page.icon}</span><span class="text-xs font-medium">${page.name}</span>`;
                bottomBtn.onclick = () => showPage(key);
                bottomNavItems.appendChild(bottomBtn);
            });

            // Mobile menu toggle
            document.getElementById('mobile-menu-btn').onclick = () => {
                const menu = document.getElementById('mobile-menu');
                toggleMobileMenu(!menu.classList.contains('hidden'));
            };
        }

        // Toggle mobile menu
        function toggleMobileMenu(show) {
            const menu = document.getElementById('mobile-menu');
            const btn = document.getElementById('mobile-menu-btn');
            
            if (show) {
                menu.classList.remove('hidden');
                btn.innerHTML = '<span class="text-xl">‚úï</span>';
            } else {
                menu.classList.add('hidden');
                btn.innerHTML = '<span class="text-xl">‚ò∞</span>';
            }
        }

        // Show page
        function showPage(page) {
            currentPage = page;
            
            // Hide all pages
            document.querySelectorAll('.page-content').forEach(el => {
                el.classList.add('hidden');
            });
            
            // Show current page
            const pageElement = document.getElementById(`page-${page}`);
            if (pageElement) {
                pageElement.classList.remove('hidden');
                pageElement.classList.add('fade-in');
            }
            
            // Update navigation
            updateNavigation();
            
            // Load page data
            loadPageData(page);
        }

        // Update navigation active states
        function updateNavigation() {
            const pageKeys = Object.keys(pages);
            
            // Update all navigation buttons
            [document.getElementById('desktop-nav').children,
             document.getElementById('mobile-nav-items').children,
             document.getElementById('bottom-nav-items').children].forEach(btns => {
                Array.from(btns).forEach((btn, index) => {
                    const pageKey = pageKeys[index];
                    
                    // Remove active classes
                    btn.classList.remove('bg-indigo-100', 'text-indigo-700');
                    
                    // Add active classes if current page
                    if (currentPage === pageKey) {
                        btn.classList.add('bg-indigo-100', 'text-indigo-700');
                    }
                });
            });
        }

        // Load user data
        async function loadUserData() {
            try {
                const initData = window.Telegram?.WebApp?.initData || 'user=%7B%22id%22%3A12345%2C%22first_name%22%3A%22Demo%22%2C%22username%22%3A%22demo_user%22%7D';
                
                const response = await fetch('/api/user', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ initData })
                });

                if (response.ok) {
                    userData = await response.json();
                    displayUserData(userData);
                    showMainApp();
                } else {
                    throw new Error('User not found');
                }
            } catch (error) {
                console.error('Error loading user data:', error);
                showError('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–∏—Å—Ç–µ–º–µ');
            }
        }

        // Display user data
        function displayUserData(user) {
            // Update welcome section
            document.getElementById('welcome-text').textContent = `–ü—Ä–∏–≤–µ—Ç, ${user.name.split(' ')[0]}! üëã`;
            document.getElementById('bonus-display').textContent = formatMoney(user.balance);
            
            // Update sidebar
            document.getElementById('sidebar-user-name').textContent = user.name.split(' ')[0];
            document.getElementById('sidebar-user-balance').textContent = formatMoney(user.balance);
            document.getElementById('user-avatar').textContent = user.name.split(' ').map(n => n[0]).join('');
            
            // Update profile
            document.getElementById('profile-name').value = user.name;
            document.getElementById('profile-phone').value = user.phone;
            document.getElementById('profile-telegram-id').value = user.id;
            
            // Update quick stats
            updateQuickStats(user);
            
            // Update loyalty card
            updateLoyaltyCard(user);
        }

        // Update quick stats
        function updateQuickStats(user) {
            const statsContainer = document.getElementById('quick-stats');
            const level = loyaltyLevels[user.levelId] || loyaltyLevels[1];
            
            const stats = [
                { icon: 'üëë', label: '–°—Ç–∞—Ç—É—Å', value: level.name, gradient: 'from-yellow-400 to-yellow-600' },
                { icon: 'üîß', label: '–í–∏–∑–∏—Ç–æ–≤', value: user.totalVisits, gradient: 'from-emerald-400 to-emerald-600' },
                { icon: 'üí∞', label: '–ü–æ—Ç—Ä–∞—á–µ–Ω–æ', value: formatMoney(user.totalSpent), gradient: 'from-blue-400 to-blue-600' },
                { icon: '‚≠ê', label: '–ü–æ–ª—É—á–µ–Ω–æ', value: formatMoney(user.totalEarned), gradient: 'from-purple-400 to-purple-600' }
            ];
            
            statsContainer.innerHTML = stats.map(stat => `
                <div class="group bg-white rounded-2xl p-5 shadow-sm border border-gray-100 btn-hover">
                    <div class="flex items-center space-x-3">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-br ${stat.gradient} flex items-center justify-center text-xl">
                            ${stat.icon}
                        </div>
                        <div>
                            <p class="text-gray-500 text-sm font-medium">${stat.label}</p>
                            <p class="text-gray-900 font-bold">${stat.value}</p>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Update loyalty card
        function updateLoyaltyCard(user) {
            const level = loyaltyLevels[user.levelId] || loyaltyLevels[1];
            const nextLevelId = user.levelId + 1;
            const nextLevel = loyaltyLevels[nextLevelId];
            
            document.getElementById('loyalty-level-name').textContent = level.name;
            document.getElementById('loyalty-level-benefits').textContent = `${level.bonus}% –∫—ç—à–±—ç–∫ ‚Ä¢ –¥–æ ${level.discount}% —Å–∫–∏–¥–∫–∞`;
            
            if (nextLevel) {
                const progress = Math.min(((user.totalSpent - level.min) / (nextLevel.min - level.min)) * 100, 100);
                const needed = Math.max(0, nextLevel.min - user.totalSpent);
                
                document.getElementById('loyalty-progress').style.width = `${progress}%`;
                document.getElementById('loyalty-progress-text').textContent = `–î–æ ${nextLevel.name}: ${formatMoney(needed)}`;
            } else {
                document.getElementById('loyalty-progress').style.width = '100%';
                document.getElementById('loyalty-progress-text').textContent = '–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å!';
            }
        }

        // Load page-specific data
        function loadPageData(page) {
            switch(page) {
                case 'visits':
                    loadVisits();
                    break;
                case 'transactions':
                    loadTransactions();
                    break;
                case 'maintenance':
                    loadMaintenance();
                    break;
                case 'booking':
                    loadServices();
                    break;
                case 'dashboard':
                    loadRecentTransactions();
                    loadAnalyticsChart();
                    break;
            }
        }

        // Load visits
        async function loadVisits() {
            try {
                const response = await fetch(`/api/visits/${userData.id}`);
                if (response.ok) {
                    const visits = await response.json();
                    displayVisits(visits);
                }
            } catch (error) {
                console.error('Error loading visits:', error);
            }
        }

        // Display visits
        function displayVisits(visits) {
            const container = document.getElementById('visits-list');
            
            if (visits.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8">
                        <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-gray-100 flex items-center justify-center text-2xl">üìã</div>
                        <p class="text-gray-500">–ü–æ—Å–µ—â–µ–Ω–∏–π –ø–æ–∫–∞ –Ω–µ—Ç</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = visits.map(visit => `
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 btn-hover">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-lg font-bold text-gray-900">${visit.title}</h3>
                        <span class="text-lg font-bold text-indigo-600">${formatMoney(visit.amount)}</span>
                    </div>
                    <div class="flex items-center justify-between text-sm text-gray-500 mb-3">
                        <span>üìÖ ${formatDate(visit.date)}</span>
                        <span class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs">
                            +${formatMoney(visit.bonusEarned)} –±–æ–Ω—É—Å–æ–≤
                        </span>
                    </div>
                </div>
            `).join('');
        }

        // Load transactions
        async function loadTransactions() {
            try {
                const response = await fetch(`/api/transactions/${userData.id}`);
                if (response.ok) {
                    const transactions = await response.json();
                    displayTransactions(transactions);
                }
            } catch (error) {
                console.error('Error loading transactions:', error);
            }
        }

        // Display transactions
        function displayTransactions(transactions) {
            const container = document.getElementById('transactions-list');
            
            if (transactions.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8">
                        <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-gray-100 flex items-center justify-center text-2xl">üí∞</div>
                        <p class="text-gray-500">–û–ø–µ—Ä–∞—Ü–∏–π –ø–æ–∫–∞ –Ω–µ—Ç</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = transactions.map(transaction => `
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 btn-hover">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            <div class="w-12 h-12 rounded-xl ${
                                transaction.type === 'accrual' ? 'bg-green-100' : 'bg-red-100'
                            } flex items-center justify-center text-xl">
                                ${transaction.type === 'accrual' ? '‚ûï' : '‚ûñ'}
                            </div>
                            <div>
                                <p class="text-gray-900 font-medium">${transaction.description}</p>
                                <p class="text-gray-500 text-sm">üìÖ ${formatDate(transaction.date)}</p>
                            </div>
                        </div>
                        <span class="text-lg font-bold ${
                            transaction.type === 'accrual' ? 'text-green-600' : 'text-red-600'
                        }">
                            ${transaction.type === 'accrual' ? '+' : ''}${formatMoney(Math.abs(transaction.amount))}
                        </span>
                    </div>
                </div>
            `).join('');
        }

        // Load recent transactions for dashboard
        async function loadRecentTransactions() {
            try {
                const response = await fetch(`/api/transactions/${userData.id}`);
                if (response.ok) {
                    const transactions = await response.json();
                    displayRecentTransactions(transactions.slice(0, 5));
                }
            } catch (error) {
                console.error('Error loading recent transactions:', error);
            }
        }

        // Display recent transactions
        function displayRecentTransactions(transactions) {
            const container = document.getElementById('recent-transactions');
            
            if (transactions.length === 0) {
                container.innerHTML = `<div class="text-center py-4"><p class="text-gray-500 text-sm">–û–ø–µ—Ä–∞—Ü–∏–π –ø–æ–∫–∞ –Ω–µ—Ç</p></div>`;
                return;
            }
            
            container.innerHTML = transactions.map(transaction => `
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-xl hover:bg-gray-100 transition-colors cursor-pointer">
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 rounded-lg ${
                            transaction.type === 'accrual' ? 'bg-green-100' : 'bg-red-100'
                        } flex items-center justify-center text-sm">
                            ${transaction.type === 'accrual' ? '‚ûï' : '‚ûñ'}
                        </div>
                        <div>
                            <p class="text-gray-900 font-medium text-sm">${transaction.description}</p>
                            <p class="text-gray-500 text-xs">${formatDate(transaction.date)}</p>
                        </div>
                    </div>
                    <span class="text-sm font-bold ${
                        transaction.type === 'accrual' ? 'text-green-600' : 'text-red-600'
                    }">
                        ${transaction.type === 'accrual' ? '+' : ''}${formatMoney(Math.abs(transaction.amount))}
                    </span>
                </div>
            `).join('');
        }

        // Load maintenance data
        async function loadMaintenance() {
            try {
                const response = await fetch(`/api/maintenance/${userData.id}`);
                if (response.ok) {
                    const maintenance = await response.json();
                    displayMaintenance(maintenance);
                }
            } catch (error) {
                console.error('Error loading maintenance:', error);
            }
        }

        // Display maintenance
        function displayMaintenance(maintenance) {
            const container = document.getElementById('maintenance-list');
            
            container.innerHTML = maintenance.map(item => `
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 btn-hover">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold text-gray-900">${item.title}</h3>
                        <span class="px-3 py-1 rounded-full text-xs font-medium ${getStatusColor(item.status)}">
                            ${getStatusText(item.status)}
                        </span>
                    </div>
                    <p class="text-gray-500 text-sm mb-4">${item.subtitle}</p>
                    ${item.lastPerformed ? `
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-500">–ü–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑:</span>
                                <span class="text-gray-900">${formatDate(item.lastPerformed)}</span>
                            </div>
                        </div>
                    ` : `
                        <p class="text-gray-500 text-sm italic">–†–∞–±–æ—Ç–∞ –µ—â–µ –Ω–µ –≤—ã–ø–æ–ª–Ω—è–ª–∞—Å—å</p>
                    `}
                </div>
            `).join('');
        }

        // Get status color
        function getStatusColor(status) {
            switch(status) {
                case 'ok': return 'bg-green-100 text-green-800';
                case 'soon': return 'bg-yellow-100 text-yellow-800';
                case 'overdue': return 'bg-red-100 text-red-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        // Get status text
        function getStatusText(status) {
            switch(status) {
                case 'ok': return '–í –ø–æ—Ä—è–¥–∫–µ';
                case 'soon': return '–°–∫–æ—Ä–æ';
                case 'overdue': return '–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ';
                default: return '–ù–µ –≤—ã–ø–æ–ª–Ω—è–ª–æ—Å—å';
            }
        }

        // Load services
        async function loadServices() {
            try {
                const response = await fetch('/api/services');
                if (response.ok) {
                    const services = await response.json();
                    displayServices(services);
                }
            } catch (error) {
                console.error('Error loading services:', error);
            }
        }

        // Display services
        function displayServices(services) {
            const container = document.getElementById('services-list');
            
            container.innerHTML = services.map(service => `
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 btn-hover cursor-pointer group">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 rounded-xl bg-indigo-100 flex items-center justify-center text-2xl group-hover:scale-110 transition-transform">
                            üîß
                        </div>
                        <span class="text-xl font-bold text-gray-900">${formatMoney(service.price)}</span>
                    </div>
                    <h3 class="text-lg font-bold text-gray-900 mb-2">${service.title}</h3>
                    <p class="text-gray-500 text-sm mb-4">‚è±Ô∏è ${service.duration}</p>
                    <button class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded-xl font-medium transition-colors">
                        –ó–∞–ø–∏—Å–∞—Ç—å—Å—è
                    </button>
                </div>
            `).join('');
        }

        // Load analytics chart
        function loadAnalyticsChart() {
            const ctx = document.getElementById('analyticsChart').getContext('2d');
            
            const data = [
                { month: '–Ø–Ω–≤', spent: 12500 },
                { month: '–§–µ–≤', spent: 8300 },
                { month: '–ú–∞—Ä', spent: 15600 },
                { month: '–ê–ø—Ä', spent: 11200 },
                { month: '–ú–∞–π', spent: 18900 },
                { month: '–ò—é–Ω', spent: 9800 }
            ];
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.month),
                    datasets: [{
                        label: '–¢—Ä–∞—Ç—ã',
                        data: data.map(d => d.spent),
                        borderColor: '#6366F1',
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { display: false } },
                        y: {
                            grid: { color: 'rgba(0, 0, 0, 0.05)' },
                            ticks: { callback: function(value) { return formatMoney(value); } }
                        }
                    },
                    elements: { point: { radius: 4, hoverRadius: 6 } }
                }
            });
        }

        // Redeem bonuses
        function redeemBonuses() {
            document.getElementById('available-balance').textContent = formatMoney(userData.balance);
            document.getElementById('redeem-modal').classList.remove('hidden');
        }

        // Close redeem modal
        function closeRedeemModal() {
            document.getElementById('redeem-modal').classList.add('hidden');
            document.getElementById('redeem-amount').value = '';
            document.getElementById('redeem-description').value = '';
        }

        // Confirm redeem
        async function confirmRedeem() {
            const amount = parseInt(document.getElementById('redeem-amount').value);
            const description = document.getElementById('redeem-description').value;
            
            if (!amount || amount <= 0) {
                showToast('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É', 'error');
                return;
            }
            
            if (amount > userData.balance) {
                showToast('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–æ–Ω—É—Å–æ–≤', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/redeem', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: userData.id,
                        amount: amount,
                        description: description
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    userData.balance = result.newBalance;
                    displayUserData(userData);
                    closeRedeemModal();
                    showToast(result.message, 'success');
                } else {
                    const error = await response.json();
                    showToast(error.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–ø–∏—Å–∞–Ω–∏–∏', 'error');
                }
            } catch (error) {
                showToast('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error');
            }
        }

        // Show toast notification
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `px-4 py-3 rounded-xl text-white font-medium shadow-lg transform transition-all duration-300 translate-x-full ${
                type === 'success' ? 'bg-green-500' : 
                type === 'error' ? 'bg-red-500' : 'bg-blue-500'
            }`;
            toast.textContent = message;
            
            container.appendChild(toast);
            
            setTimeout(() => toast.classList.remove('translate-x-full'), 100);
            
            setTimeout(() => {
                toast.classList.add('translate-x-full');
                setTimeout(() => container.removeChild(toast), 300);
            }, 3000);
        }

        // Show main app
        function showMainApp() {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('mobile-header').classList.remove('hidden');
            document.getElementById('desktop-sidebar').classList.remove('hidden');
            document.getElementById('mobile-bottom-nav').classList.remove('hidden');
            showPage('dashboard');
        }

        // Show error
        function showError(message) {
            document.getElementById('loading').innerHTML = `
                <div class="text-center text-white">
                    <div class="w-20 h-20 mx-auto mb-4 rounded-2xl bg-white/20 glass-effect flex items-center justify-center text-3xl">‚ùå</div>
                    <h1 class="text-2xl font-bold mb-2">–û—à–∏–±–∫–∞</h1>
                    <p class="text-indigo-200">${message}</p>
                    <button onclick="location.reload()" class="mt-4 px-6 py-2 bg-white/20 rounded-xl font-medium hover:bg-white/30 transition-colors">
                        –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
                    </button>
                </div>
            `;
        }

        // Utility functions
        function formatMoney(amount) {
            return new Intl.NumberFormat('ru-RU', {
                style: 'currency',
                currency: 'RUB',
                minimumFractionDigits: 0
            }).format(amount);
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('ru-RU', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }
    </script>
</body>
</html>
